<!DOCTYPE html>
<html>
<head>
    <title>Pusher Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Pusher Connection Test</h1>
    
    <div id="status" class="status disconnected">
        Disconnected
    </div>
    
    <button onclick="testConnection()">Test Pusher Connection</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="log" class="log"></div>

    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, connected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testConnection() {
            log('Starting Pusher connection test...');
            
            const pusher = new Pusher('1e4d1e2b0527bdbbbea7', {
                cluster: 'us2',
                forceTLS: true,
                authEndpoint: '/api/pusher/auth',
                auth: {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': 'test-user',
                        'x-user-name': 'Test User',
                        'x-user-photo': ''
                    }
                }
            });

            pusher.connection.bind('connecting', () => {
                log('🔄 Connecting to Pusher...');
            });

            pusher.connection.bind('connected', () => {
                log('✅ Connected to Pusher successfully!');
                updateStatus('Connected to Pusher', true);
                
                // Test regular channel
                const channel = pusher.subscribe('chat-public-general-chat');
                channel.bind('pusher:subscription_succeeded', () => {
                    log('✅ Subscribed to regular channel');
                });
                
                // Test presence channel
                const presenceChannel = pusher.subscribe('presence-public-general-chat');
                presenceChannel.bind('pusher:subscription_succeeded', (data) => {
                    log('✅ Subscribed to presence channel');
                    log(`Current members: ${Object.keys(data.members || {}).length}`);
                });
                
                presenceChannel.bind('pusher:subscription_error', (error) => {
                    log(`❌ Presence channel error: ${JSON.stringify(error)}`);
                });
            });

            pusher.connection.bind('disconnected', () => {
                log('❌ Disconnected from Pusher');
                updateStatus('Disconnected from Pusher', false);
            });

            pusher.connection.bind('error', (error) => {
                log(`❌ Pusher error: ${JSON.stringify(error)}`);
                updateStatus('Error: ' + error.message, false);
            });

            pusher.connection.bind('state_change', (states) => {
                log(`🔄 State changed: ${states.previous} -> ${states.current}`);
            });
        }

        // Auto-test on load
        window.onload = () => {
            log('Page loaded, ready to test Pusher connection');
        };
    </script>
</body>
</html>
