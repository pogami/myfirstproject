<!DOCTYPE html>
<html>
<head>
    <title>Real-time Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .chat-box { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .message { margin: 5px 0; padding: 5px; border-radius: 5px; }
        .user-message { background-color: #e3f2fd; text-align: right; }
        .other-message { background-color: #f5f5f5; }
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 10px; }
        .input-area button { padding: 10px 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-time Messaging Test</h1>
        
        <div id="status" class="status disconnected">
            Disconnected
        </div>
        
        <div class="input-area">
            <input type="text" id="username" placeholder="Enter your username" value="TestUser1">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>
        
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">Send</button>
        </div>
        
        <div id="chatBox" class="chat-box"></div>
        
        <div id="typingIndicator"></div>
    </div>

    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>
        let pusher = null;
        let channel = null;
        let username = '';
        let isConnected = false;

        function connect() {
            username = document.getElementById('username').value || 'Anonymous';
            
            if (pusher) {
                pusher.disconnect();
            }

            pusher = new Pusher('1e4d1e2b0527bdbbbea7', {
                cluster: 'us2',
                forceTLS: true,
                authEndpoint: '/api/pusher/auth',
                auth: {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': username,
                        'x-user-name': username,
                        'x-user-photo': ''
                    }
                }
            });

            pusher.connection.bind('connected', () => {
                console.log('‚úÖ Connected to Pusher!');
                updateStatus('Connected to Pusher', true);
                isConnected = true;
                
                // Subscribe to the chat channel
                channel = pusher.subscribe('chat-public-general-chat');
                
                channel.bind('pusher:subscription_succeeded', () => {
                    console.log('‚úÖ Subscribed to chat channel');
                    addMessage('System', 'Connected to chat channel', 'system');
                });

                // Listen for messages
                channel.bind('client-new-message', (data) => {
                    console.log('üì® Received message:', data);
                    if (data.userId !== username) {
                        addMessage(data.name || data.userName, data.text, 'other');
                    }
                });

                // Listen for typing indicators
                channel.bind('client-user-typing', (data) => {
                    if (data.userId !== username) {
                        showTypingIndicator(data.userName);
                    }
                });

                channel.bind('client-user-stopped-typing', (data) => {
                    if (data.userId !== username) {
                        hideTypingIndicator();
                    }
                });
            });

            pusher.connection.bind('disconnected', () => {
                console.log('‚ùå Disconnected from Pusher');
                updateStatus('Disconnected from Pusher', false);
                isConnected = false;
            });

            pusher.connection.bind('error', (error) => {
                console.error('‚ùå Pusher error:', error);
                updateStatus('Error: ' + error.message, false);
            });
        }

        function disconnect() {
            if (pusher) {
                pusher.disconnect();
                pusher = null;
                channel = null;
                isConnected = false;
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !isConnected || !channel) {
                return;
            }

            const messageData = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                text: message,
                sender: 'user',
                name: username,
                userId: username,
                timestamp: Date.now()
            };

            // Add message to local chat
            addMessage(username, message, 'user');
            
            // Send via Pusher
            channel.trigger('client-new-message', messageData);
            
            messageInput.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(sender, text, type) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updateStatus(message, connected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function showTypingIndicator(userName) {
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = `${userName} is typing...`;
            indicator.style.display = 'block';
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
        }

        // Auto-connect on page load
        window.onload = () => {
            connect();
        };
    </script>
</body>
</html>
